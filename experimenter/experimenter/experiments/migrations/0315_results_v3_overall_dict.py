# Generated by Django 5.2.9 on 2026-01-20 18:37

from django.db import migrations


def fix_overall_empty_list(apps, schema_editor):
    NimbusExperiment = apps.get_model("experiments", "NimbusExperiment")

    for experiment in NimbusExperiment.objects.all():
        data = experiment.results_data
        if data is not None and "v3" in data:
            modified = False
            for key, value in data["v3"].items():
                if value is None or key not in ["weekly", "overall"]:
                    continue
                for basis, basis_data in value.items():
                    for segment, segment_data in basis_data.items():
                        for cur_branch, branch_data_obj in segment_data.items():
                            branch_data = branch_data_obj["branch_data"]
                            for metrics_group, metrics in branch_data.items():
                                for metric, metric_data in metrics.items():
                                    if "significance" in metric_data:
                                        significance_data = metric_data["significance"]
                                        if isinstance(significance_data, dict):
                                            for comparison_branch, comparison_data in significance_data.items():
                                                if isinstance(comparison_data, dict) and "overall" in comparison_data:
                                                    if comparison_data["overall"] == []:
                                                        comparison_data["overall"] = {}
                                                        modified = True
            if modified:
                experiment.results_data = data
                experiment.save()


class Migration(migrations.Migration):

    dependencies = [
        ('experiments', '0314_nimbusexperiment_risk_ai'),
    ]

    operations = [
        migrations.RunPython(fix_overall_empty_list, migrations.RunPython.noop),
    ]
