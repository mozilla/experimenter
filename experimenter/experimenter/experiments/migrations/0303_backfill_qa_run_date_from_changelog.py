# Generated by Django 5.2.2 on 2025-01-20 15:50

from django.db import migrations


def backfill_qa_run_date_from_changelog(apps, schema_editor):
    NimbusExperiment = apps.get_model("experiments", "NimbusExperiment")

    experiments_to_update = NimbusExperiment.objects.filter(
        qa_run_date__isnull=True
    ).exclude(
        qa_status="NOT_SET"
    )

    for experiment in experiments_to_update:
        # Find the most recent changelog where qa_status matches the current value
        # This represents when the qa_status was last set to its current value
        latest_qa_changelog = (
            experiment.changes.all()
            .filter(experiment_data__qa_status=experiment.qa_status)
            .order_by("-changed_on")
            .first()
        )

        if latest_qa_changelog:
            experiment.qa_run_date = latest_qa_changelog.changed_on.date()
            experiment.save(update_fields=["qa_run_date"])


class Migration(migrations.Migration):
    dependencies = [
        ("experiments", "0302_nimbusexperiment_firefox_min_version_parsed")
    ]

    operations = [
        migrations.RunPython(
            backfill_qa_run_date_from_changelog,
            reverse_code=migrations.RunPython.noop,
        ),
    ]
