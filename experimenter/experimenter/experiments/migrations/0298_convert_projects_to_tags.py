# Generated by Django 5.2.2 on 2025-01-20 15:50

from django.db import migrations
import random


def convert_projects_to_tags(apps, schema_editor):
    Project = apps.get_model("projects", "Project")
    Tag = apps.get_model("experiments", "Tag")
    NimbusExperiment = apps.get_model("experiments", "NimbusExperiment")

    # Create tags from existing projects
    for project in Project.objects.all():
        # Generate random hex color
        random_color = "#{:06x}".format(random.randint(0, 0xFFFFFF))
        tag, created = Tag.objects.get_or_create(
            name=project.name,
            defaults={'color': random_color}
        )

        # Find all experiments associated with this project and add the tag
        experiments = NimbusExperiment.objects.filter(projects=project)
        for experiment in experiments:
            experiment.tags.add(tag)


class Migration(migrations.Migration):
    dependencies = [
        ("experiments", "0297_nimbusfeatureconfig_subscribers")
    ]

    operations = [
        migrations.RunPython(
            convert_projects_to_tags,
        ),
    ]
