# Generated by Django 3.2.2 on 2021-05-10 21:34

from django.db import migrations


def restore_feature_configs(apps, schema_editor):
    NimbusExperiment = apps.get_model("experiments", "NimbusExperiment")
    NimbusFeatureConfig = apps.get_model("experiments", "NimbusFeatureConfig")
    for experiment in NimbusExperiment.objects.all():
        feature_slug = (
            experiment.changes.all()
            .exclude(experiment_data__feature_config=None)
            .exclude(experiment_data__feature_config__slug="no-feature-firefox-desktop")
            .exclude(experiment_data__feature_config__slug="no-feature-fenix")
            .exclude(experiment_data__feature_config__slug="no-feature-ios")
            .order_by("-changed_on")
            .values_list("experiment_data__feature_config__slug", flat=True)
            .first()
        )

        if feature_slug:
            feature_config = NimbusFeatureConfig.objects.get(slug=feature_slug)
            experiment.feature_config = feature_config
            experiment.save()


class Migration(migrations.Migration):

    dependencies = [
        ("experiments", "0169_risk_questions_false"),
    ]

    operations = [
        migrations.RunPython(
            restore_feature_configs, reverse_code=lambda apps, schema_editor: None
        ),
    ]
