# Generated by Django 5.2.8 on 2025-11-20 21:38

import django.contrib.postgres.fields
from django.db import migrations, models
from packaging import version

def populate_firefox_min_version_parsed(apps, schema_editor):
    NimbusExperiment = apps.get_model("experiments", "NimbusExperiment")

    experiments_to_update = []
    for experiment in NimbusExperiment.objects.exclude(firefox_min_version=""):
        try:
            parsed = version.parse(experiment.firefox_min_version.replace("!", "0"))
            experiment._firefox_min_version_parsed = [
                parsed.major,
                parsed.minor,
                parsed.micro,
            ]
            experiments_to_update.append(experiment)
        except Exception:
            pass

    if experiments_to_update:
        NimbusExperiment.objects.bulk_update(
            experiments_to_update, ["_firefox_min_version_parsed"], batch_size=500
        )


class Migration(migrations.Migration):

    dependencies = [
        ('experiments', '0301_alter_nimbusdocumentationlink_title'),
    ]

    operations = [
        migrations.AddField(
            model_name='nimbusexperiment',
            name='_firefox_min_version_parsed',
            field=django.contrib.postgres.fields.ArrayField(base_field=models.IntegerField(), default=[0, 0, 0], verbose_name="Firefox Minimum Version (Parsed)", help_text='Parsed version as [major, minor, patch] for sorting', size=3),
        ),
        migrations.RunPython(populate_firefox_min_version_parsed),
    ]
