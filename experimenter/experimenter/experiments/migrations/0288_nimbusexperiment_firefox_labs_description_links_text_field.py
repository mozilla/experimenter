# Generated by Django 5.2.2 on 2025-08-19 15:37
import json

from django.db import migrations, models
from django.db.models import Q


def normalize_description_links(apps, schema_editor):
    NimbusExperiment = apps.get_model("experiments", "NimbusExperiment")

    experiments = list(NimbusExperiment.objects.filter(is_firefox_labs_opt_in=True))
    for experiment in experiments:
        value = experiment.firefox_labs_description_links

        if isinstance(value, str):
            if value == '""':
                new_value = None
            else:
                try:
                    new_value = json.loads(value)
                except Exception as e:
                    # If its not a valid json value, we're gonna leave it as is.
                    continue

            experiment.firefox_labs_description_links = new_value
            experiment.save()


class Migration(migrations.Migration):
    dependencies = [
        ("experiments", "0287_nimbusexperiment_channels"),
    ]

    operations = [
        migrations.RunPython(normalize_description_links),
        migrations.AlterField(
            model_name="nimbusexperiment",
            name="firefox_labs_description_links",
            field=models.TextField(
                blank=True,
                default=None,
                null=True,
                verbose_name="Firefox Labs Description Links",
            ),
        ),
    ]
