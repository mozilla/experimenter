{% load nimbus_extras %}

<div class="dropdown dropup date-filter ms-1 position-static">
  <button class="btn btn-sm p-0 border-0 bg-transparent position-relative"
          type="button"
          data-bs-toggle="dropdown"
          aria-expanded="false"
          id="dateFilterDropdown{{ dropdown_id }}"
          title="Filter by Date">
    <i class="fa-solid fa-filter text-body"></i>
    {% if form.date_range.value and form.date_range.value != "" %}
      <span class="badge bg-primary"
            style="position: absolute;
                   top: -5px;
                   right: -5px;
                   font-size: 0.6em">1</span>
    {% elif selected_values and selected_values != "" and selected_values != None %}
      <span class="badge bg-primary"
            style="position: absolute;
                   top: -5px;
                   right: -5px;
                   font-size: 0.6em">1</span>
    {% elif request.GET.start_date or request.GET.end_date %}
      <span class="badge bg-primary"
            style="position: absolute;
                   top: -5px;
                   right: -5px;
                   font-size: 0.6em">1</span>
    {% endif %}
  </button>
  <div class="dropdown-menu p-2 shadow-sm border rounded-2"
       style="min-width: 280px;
              max-height: 50vh;
              overflow: auto">
    <strong class="dropdown-header">Filter by Date</strong>
    <div class="m-0 date-filter">
      {% for choice_value, choice_label in choices %}
        {% if choice_value not in "custom" %}
          <div class="form-check" id="filter-choice-date_range-{{ choice_value }}">
            <input class="form-check-input"
                   type="radio"
                   name="date_range"
                   value="{{ choice_value }}"
                   id="date_range-{{ choice_value }}"
                   {% if choice_value == form.date_range.value %}checked{% endif %}
                   hx-get="{{ url }}"
                   hx-target="{{ hx_target }}"
                   hx-select="{{ hx_select }}"
                   hx-swap="outerHTML"
                   hx-trigger="change"
                   hx-include="input:checked, select"
                   hx-vals='{"date_range": "{{ choice_value }}"}'>
            <label class="form-check-label" for="date_range-{{ choice_value }}">{{ choice_label }}</label>
          </div>
        {% endif %}
      {% endfor %}
      <hr class="my-2">
      <div class="form-check">
        <input class="form-check-input"
               type="radio"
               name="date_range"
               value="custom"
               id="date_range-custom"
               {% if form.date_range.value == "custom" or request.GET.start_date or request.GET.end_date %}checked{% endif %}
               hx-get="{{ url }}"
               hx-target="{{ hx_target }}"
               hx-select="{{ hx_select }}"
               hx-swap="outerHTML"
               hx-trigger="change"
               hx-include="input:checked, select, input[name='start_date'], input[name='end_date']"
               hx-vals='{"date_range": "custom"}'>
        <label class="form-check-label w-100" for="date_range-custom">
          <div class="d-flex flex-column">
            <span class="mb-2">Custom Date Range:</span>
            <div class="d-flex align-items-center mb-2">
              <label class="me-2" style="min-width: 80px;">Start Date:</label>
              <input type="date"
                     name="start_date"
                     class="form-control form-control-sm"
                     style="width: 150px"
                     value="{{ request.GET.start_date|default:'' }}"
                     min="2000-01-01"
                     onclick="document.getElementById('date_range-custom').checked = true;"
                     hx-get="{{ url }}"
                     hx-target="{{ hx_target }}"
                     hx-select="{{ hx_select }}"
                     hx-swap="outerHTML"
                     hx-trigger="change delay:500ms"
                     hx-include="input:checked, select, input[name='start_date'], input[name='end_date']"
                     hx-vals='{"date_range": "custom"}'>
            </div>
            <div class="d-flex align-items-center">
              <label class="me-2" style="min-width: 80px;">End Date:</label>
              <input type="date"
                     name="end_date"
                     class="form-control form-control-sm"
                     style="width: 150px"
                     value="{{ request.GET.end_date|default:'' }}"
                     min="2000-01-01"
                     onclick="document.getElementById('date_range-custom').checked = true;"
                     hx-get="{{ url }}"
                     hx-target="{{ hx_target }}"
                     hx-select="{{ hx_select }}"
                     hx-swap="outerHTML"
                     hx-trigger="change delay:500ms"
                     hx-include="input:checked, select, input[name='start_date'], input[name='end_date']"
                     hx-vals='{"date_range": "custom"}'>
            </div>
          </div>
        </label>
      </div>
    </div>
  </div>
</div>
