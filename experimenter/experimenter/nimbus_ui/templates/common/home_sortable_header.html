<th scope="col" class="fw-bold align-top">
  <div class="d-flex align-items-center">
    {# ------------------------- SORT FORM ------------------------- #}
    <form method="get"
      hx-get="{{ url }}"
      hx-trigger="submit"
      hx-target="{{ hx_target }}"
      hx-select="{{ hx_select }}"
      hx-swap="outerHTML"
      hx-include=".type-filter input[name='type']:checked"  {# keep current Type when sorting #}
      class="d-inline-block m-0">
      {# Preserve ALL existing filters except "sort" (we set it explicitly) #}
      {% for form_field in form %}
        {% if form_field.name != "sort" %}
          {% if form_field.value %}{{ form_field.as_hidden }}{% endif %}
        {% endif %}
      {% endfor %}
      {# Compute next sort value for this header only when the header button is clicked #}
      {% if current_sort == field %}
        <input type="hidden" name="sort" value="-{{ field }}">
      {% elif current_sort == "-"|add:field %}
        <input type="hidden" name="sort" value="{{ field }}">
      {% else %}
        <input type="hidden" name="sort" value="{{ field }}">
      {% endif %}
      <button type="submit"
              class="btn p-0 text-body fw-semibold text-decoration-none">
        <span class="d-flex align-items-center">
          {{ label }}
          {% if current_sort == field %}
            <i class="ps-1 fa-solid fa-chevron-up"></i>
          {% elif current_sort == "-"|add:field %}
            <i class="ps-1 fa-solid fa-chevron-down"></i>
          {% endif %}
        </span>
      </button>
    </form>
    {# ------------------------ FILTER FORM (Type) ------------------------ #}
    {% if field == "is_rollout" %}
      <div class="dropdown dropup ms-1 position-static">
        <button class="btn btn-sm p-0 border-0 bg-transparent"
                type="button"
                id="typeFilterDropdown-{{ forloop.parentloop.counter0|default:0 }}-{{ forloop.counter0|default:0 }}"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                title="Filter by Type">
          <i class="fa-solid fa-filter text-body"></i>
        </button>
        <div class="dropdown-menu p-2 shadow-sm border rounded-2"
             style="min-width:180px;
                    max-height:50vh;
                    overflow:auto">
          <strong class="dropdown-header">Filter by Type</strong>
          <form method="get"
                hx-get="{{ url }}"
                hx-trigger="change"
                hx-target="{{ hx_target }}"
                hx-select="{{ hx_select }}"
                hx-swap="outerHTML"
                class="m-0 type-filter">
            {# Preserve all other filters (not "type") and keep CURRENT sort #}
            {% for form_field in form %}
              {% if form_field.name != "type" and form_field.name != "sort" %}
                {% if form_field.value %}{{ form_field.as_hidden }}{% endif %}
              {% endif %}
            {% endfor %}
            {% if current_sort %}<input type="hidden" name="sort" value="{{ current_sort }}">{% endif %}
            {# ALWAYS reset to page 1 when Type checkboxes change #}
            <input type="hidden" name="my_deliveries_page" value="1">
            {% for value, label in form.fields.type.choices %}
              <div class="form-check">
                <input class="form-check-input"
                       type="checkbox"
                       name="type"
                       id="type-{{ forloop.counter }}"
                       value="{{ value }}"
                       {% if value in form.type.value %}checked{% endif %}>
                <label class="form-check-label" for="type-{{ forloop.counter }}">{{ label }}</label>
              </div>
            {% endfor %}
          </form>
        </div>
      </div>
    {% endif %}
  </div>
</th>
