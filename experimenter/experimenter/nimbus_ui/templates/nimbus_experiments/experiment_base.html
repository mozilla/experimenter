{% extends "common/with_sidebar.html" %}

{% load nimbus_extras %}

{% block sidebar %}
  {% include "nimbus_experiments/sidebar.html" with experiment=experiment %}

{% endblock %}

{% block main_content_header %}
  <div class="d-flex mb-2 justify-content-between flex-column flex-xxl-row column-gap-3">
    <!-- Experiment Details -->
    <div>
      <h4 class="mb-0">{{ experiment.name }}</h4>
      {% if experiment.is_archived %}
        <span class="badge rounded-pill bg-danger" id="archive-badge">Archived</span>
      {% endif %}
      {% if experiment.is_rollout %}<span class="badge rounded-pill bg-primary" id="rollout-badge">Rollout</span>{% endif %}
      {% if experiment.project_impact %}
        <span class="badge rounded-pill text-bg-warning border border-secondary-subtle"><i class="fa-solid fa-trophy me-2"></i>{{ experiment.project_impact|lower|capfirst }} impact</span>
      {% endif %}
      <span id="qa-status-header" class="{{ experiment.qa_status_badge_class }}">
        QA Status: {{ experiment.qa_status|default:"Not Set"|title }}
      </span>
      {% include "nimbus_experiments/experiment_tags.html" %}

      {% if experiment.is_rollout_dirty %}
        <span class="badge rounded-pill bg-danger" id="unpublished-rollout-badge">Unpublished changes</span>
      {% endif %}
      <div class="d-flex align-items-center mb-2">
        <button id="experiment-slug"
                type="button"
                class="btn text-secondary ps-0"
                aria-label="Copy slug">
          <span>{{ experiment.slug }}</span>
          <i class="fa-solid fa-copy"></i>
        </button>
      </div>
      <div class="d-flex align-items-center mb-3">
        <form method="post"
              action="{% url 'nimbus-ui-toggle-launch-slack-notifications' slug=experiment.slug %}"
              class="d-flex align-items-center">
          {% csrf_token %}
          <input type="hidden" name="disable_launch_slack_notifications" value="false">
          <div class="form-check form-switch">
            <input type="checkbox"
                   id="slack-notifications-toggle"
                   name="disable_launch_slack_notifications"
                   value="true"
                   {% if experiment.disable_launch_slack_notifications %}checked{% endif %}
                   onchange="this.form.submit()"
                   class="form-check-input"
                   role="switch"
                   style="cursor: pointer">
            <label for="slack-notifications-toggle"
                   class="form-check-label text-secondary small"
                   style="cursor: pointer">
              <i class="fa-solid fa-bell-slash me-1"></i>
              <span>Disable launch Slack notifications</span>
            </label>
          </div>
        </form>
      </div>
      {% if experiment.parent %}
        <p class="text-secondary small">
          Cloned from
          <a href="{% url 'nimbus-ui-detail' experiment.parent.slug %}"
             target="_blank"
             data-testid="experiment-parent"
             rel="noopener noreferrer">{{ experiment.parent.name }}</a>
        </p>
      {% endif %}
    </div>
    <!-- Experiment Timeline -->
    <div id="experiment-timeline">
      {% include "nimbus_experiments/timeline.html" %}

    </div>
  </div>
  <div id="slug-toast"
       class="toast hide text-bg-primary position-fixed top-0 end-0 m-3 w-auto"
       role="alert"
       aria-live="assertive"
       aria-atomic="true">
    <div class="toast-body">
      <i class="fa-regular fa-circle-check"></i>
      Slug copied to clipboard!
    </div>
  </div>
  <div class="modal fade"
       id="cloneModal"
       tabindex="-1"
       aria-labelledby="cloneModalLabel"
       aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="cloneModalLabel">
            <i class="fa-regular fa-copy"></i>
            Clone Experiment {{ experiment.name }}
          </h1>
          <button type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div class="modal-body bg-body-tertiary">
          <form id="cloneForm"
                hx-post="{% url 'nimbus-ui-clone' experiment.slug %}"
                hx-target="#cloneForm">
            {% csrf_token %}
            {% include "nimbus_experiments/clone.html" with form=clone_form experiment=experiment form_id_prefix="clone" %}

          </form>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="tagsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" id="tagsModalContent">
        <!-- Content will be loaded via HTMX -->
      </div>
    </div>
  </div>
{% endblock %}
