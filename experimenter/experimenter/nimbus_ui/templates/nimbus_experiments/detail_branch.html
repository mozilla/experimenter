{% load nimbus_extras %}

<div class="card mb-3" id="{{ branch.slug }}">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h4 class="mb-0">
      <a href="#{{ branch.slug }}" class="text-decoration-none text-body">
        {{ branch.name|title }} Branch ({{ branch_number }}/{{ total_branches }})
      </a>
    </h4>
    {% if not experiment.is_rollout %}
      <button class="btn btn-outline-primary btn-sm"
              data-testid="promote-rollout"
              data-bs-toggle="modal"
              data-bs-target="#promoteToRolloutModal-{{ branch.slug }}">Promote to Rollout</button>
    {% endif %}
  </div>
  <div class="card-body p-0 overflow-hidden rounded-bottom">
    <table class="table table-striped mb-0">
      <tbody>
        <tr>
          <th class="w-25">Slug</th>
          <td class="w-25">{{ branch.slug|format_not_set }}</td>
          <th class="w-25">Ratio</th>
          <td class="w-25">{{ branch.ratio|format_not_set }}</td>
        </tr>
        <tr>
          <th>Description</th>
          <td colspan="3">{{ branch.description|format_not_set }}</td>
        </tr>
        {% if branch.feature_values.all %}
          {% for feature_value in branch.feature_values.all %}
            <tr>
              <th {% if forloop.last and not branch.screenshots.all.exists %}class="border-bottom-0"{% endif %}>
                {{ feature_value.feature_config.name|format_not_set }} Value
                {% if feature_value.allow_coenrollment %}
                  <div class="form-text">{{ NimbusUIConstants.COENROLLMENT_NOTE }}</div>
                {% endif %}
              </th>
              <td colspan="3"
                  class="{% if forloop.last and not branch.screenshots.all.exists %}border-bottom-0{% endif %}">
                {% include "common/readonly_json.html" with json_content=feature_value.value %}

              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="4"
                {% if not branch.screenshots.all.exists %}class="border-bottom-0"{% endif %}>No Feature Values</td>
          </tr>
        {% endif %}
        {% if branch.screenshots.all.exists %}
          <tr>
            <th class="border-bottom-0">Screenshots</th>
            <td colspan="3" class="border-bottom-0">
              {% for screenshot in branch.screenshots.all %}
                <figure data-testid="branch-screenshot" class="d-block">
                  <figcaption>{{ screenshot.description }}</figcaption>
                  {% if screenshot.image %}
                    <img src="{{ screenshot.image.url }}"
                         alt="{{ screenshot.description|default:'' }}"
                         class="img-fluid">
                  {% else %}
                    Not Set
                  {% endif %}
                </figure>
              {% endfor %}
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
<div class="modal fade"
     id="promoteToRolloutModal-{{ branch.slug }}"
     tabindex="-1"
     aria-labelledby="promoteToRolloutModalLabel-{{ branch.slug }}"
     aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5">Promote {{ branch.slug }} to Rollout</h1>
        <button type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>
      <div class="modal-body bg-body-tertiary">
        <form id="promoteToRolloutForm-{{ branch.slug }}"
              hx-post="{% url 'nimbus-ui-promote-to-rollout' experiment.slug %}"
              hx-vals='{"branch_slug": "{{ branch.slug }}"}'
              hx-target="#promoteToRolloutForm-{{ branch.slug }}">
          {% with form_id_prefix="promote-"|add:branch.slug %}
            {% include "nimbus_experiments/clone.html" with form=promote_to_rollout_forms experiment=experiment form_id_prefix=form_id_prefix branch_slug=branch.slug %}

          {% endwith %}
        </form>
      </div>
    </div>
  </div>
</div>
