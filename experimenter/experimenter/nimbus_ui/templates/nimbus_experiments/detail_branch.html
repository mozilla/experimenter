{% load nimbus_extras %}

<div class="card mb-3" id="{{ branch.slug }}">
  <div class="card-header">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h5 class="mb-0">
          <a href="#{{ branch.slug }}" class="text-decoration-none text-body">
            {{ branch.name|title }} Branch ({{ branch_number }}/{{ total_branches }})
          </a>
        </h5>
      </div>
      {% if not experiment.is_rollout %}
        <div class="col-md-4 text-end">
          <button class="btn btn-outline-primary btn-sm"
                  data-testid="promote-rollout"
                  data-bs-toggle="modal"
                  data-bs-target="#promoteToRolloutModal-{{ branch.slug }}">Promote to Rollout</button>
        </div>
      {% endif %}
    </div>
  </div>
  <div class="card-body p-0 overflow-hidden rounded-bottom">
    <table class="table table-striped mb-0">
      <tbody>
        <tr>
          <th class="w-25">Slug</th>
          <td class="w-25">{{ branch.slug|format_not_set }}</td>
          <th class="w-25">Ratio</th>
          <td class="w-25">{{ branch.ratio|format_not_set }}</td>
        </tr>
        <tr>
          <th>Description</th>
          <td colspan="3">{{ branch.description|format_not_set }}</td>
        </tr>
        {% if branch.feature_values.all %}
          {% for feature_value in branch.feature_values.all %}
            <tr>
              <th {% if forloop.last and not branch.screenshots.all.exists %}class="border-bottom-0"{% endif %}>
                {{ feature_value.feature_config.name|format_not_set }} Value
                {% if feature_value.allow_coenrollment %}
                  <div class="form-text">{{ NimbusUIConstants.COENROLLMENT_NOTE }}</div>
                {% endif %}
              </th>
              <td colspan="3"
                  id="preview-recipe-json"
                  class="collapsed-json {% if forloop.last and not branch.screenshots.all.exists %}border-bottom-0{% endif %}">
                <div style="max-height: 120px; overflow: hidden;">
                  {% include "common/readonly_json.html" with json_content=feature_value.value %}

                </div>
                <button class="btn btn-outline-primary btn-sm mt-2 d-block show-btn d-none">
                  <i class="fa-solid fa-plus"></i> Show more
                </button>
              </td>
              <td colspan="3"
                  id="preview-recipe-json"
                  class="expanded-json d-none mw-0 {% if forloop.last and not branch.screenshots.all.exists %}border-bottom-0{% endif %}">
                <div class="text-break">
                  {% include "common/readonly_json.html" with json_content=feature_value.value %}

                </div>
                <button class="btn btn-outline-primary btn-sm mt-2 d-block hide-btn d-none">
                  <i class="fa-solid fa-minus"></i> Show less
                </button>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="4"
                {% if not branch.screenshots.all.exists %}class="border-bottom-0"{% endif %}>No Feature Values</td>
          </tr>
        {% endif %}
        {% if branch.screenshots.all.exists %}
          <tr>
            <th class="border-bottom-0">Screenshots</th>
            <td colspan="3" class="border-bottom-0">
              {% for screenshot in branch.screenshots.all %}
                <figure data-testid="branch-screenshot" class="d-block">
                  <figcaption>{{ screenshot.description }}</figcaption>
                  {% if screenshot.image %}
                    <img src="{{ screenshot.image.url }}"
                         alt="{{ screenshot.description|default:'' }}"
                         class="img-fluid">
                  {% else %}
                    Not Set
                  {% endif %}
                </figure>
              {% endfor %}
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  {% if experiment.is_firefox_labs_opt_in %}
    <div class="card-header border-top">
      <h6 class="mb-0">Firefox Labs</h6>
    </div>
    <div class="card-body p-0 overflow-hidden rounded-bottom">
      <table class="table table-striped mb-0">
        <tbody>
          <tr>
            <th>Title</th>
            <td class="w-75">{{ experiment.firefox_labs_title|default:"---" }}</td>
          </tr>
          <tr>
            <th>Description</th>
            <td class="w-75">{{ experiment.firefox_labs_description|default:"---" }}</td>
          </tr>
          <tr>
            <th>Description Links</th>
            <td class="w-75">
              {% if experiment.firefox_labs_description_links %}
                <code>{{ experiment.firefox_labs_description_links|format_not_set|format_json }}</code>
              {% else %}
                ---
              {% endif %}
            </td>
          </tr>
          <tr>
            <th>Group</th>
            <td class="w-75">{{ experiment.firefox_labs_group }}</td>
          </tr>
          <tr>
            <th class="border-bottom-0">Requires Restart?</th>
            {% if experiment.requires_restart %}
              <td class="w-75 border-bottom-0">
                <i class="fa-regular fa-circle-check text-success"></i></i>
              </td>
            {% else %}
              <td class="w-75 border-bottom-0">
                <i class="fa-regular fa-circle-xmark text-danger"></i>
              </td>
            {% endif %}
          </tr>
        </tbody>
      </table>
    </div>
  {% endif %}
</div>
<div class="modal fade"
     id="promoteToRolloutModal-{{ branch.slug }}"
     tabindex="-1"
     aria-labelledby="promoteToRolloutModalLabel-{{ branch.slug }}"
     aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5">Promote {{ branch.slug }} to Rollout</h1>
        <button type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"></button>
      </div>
      <div class="modal-body bg-body-tertiary">
        <form id="promoteToRolloutForm-{{ branch.slug }}"
              hx-post="{% url 'nimbus-ui-promote-to-rollout' experiment.slug %}"
              hx-vals='{"branch_slug": "{{ branch.slug }}"}'
              hx-target="#promoteToRolloutForm-{{ branch.slug }}">
          {% with form_id_prefix="promote-"|add:branch.slug %}
            {% include "nimbus_experiments/clone.html" with form=promote_to_rollout_forms experiment=experiment form_id_prefix=form_id_prefix branch_slug=branch.slug %}

          {% endwith %}
        </form>
      </div>
    </div>
  </div>
</div>
