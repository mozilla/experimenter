{% extends "common/with_sidebar.html" %}

{% load nimbus_extras %}

{% block title %}Summary{% endblock %}

{% block sidebar %}
  {% include "common/experiment_details_sidebar.html" with experiment=experiment %}

{% endblock %}

{% block main_content %}
  <div class="container-fluid py-4">
    <!-- Experiment Details Card -->
    <div class="card mb-3">
      <div class="card-header">
        <h4>Experiment Details</h4>
      </div>
      <div class="card-body">
        <p>
          <strong>Slug:</strong> {{ experiment.slug }}
        </p>
        <p>
          <strong>Name:</strong> {{ experiment.name }}
        </p>
      </div>
    </div>
    <!-- Takeaways Card -->
    <div class="card mb-3">
      <div class="card-header">
        <h4>Takeaways</h4>
      </div>
      <div class="card-body">
        <table class="table table-striped">
          <tbody>
            <tr>
              <th>QBR learning</th>
              <td>{{ experiment.takeaways_qbr_learning }}</td>
              <th>Statistically significant DAU Gain</th>
              <td>{{ experiment.takeaways_metric_gain }}</td>
            </tr>
            <tr>
              <th>Summary</th>
              <td colspan="3">{{ experiment.takeaways_summary|format_not_set|safe }}</td>
            </tr>
            <tr>
              <th>Gain amount</th>
              <td colspan="3">{{ experiment.takeaways_gain_amount|format_not_set |safe }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Overview Card -->
    <div class="card mb-3">
      <div class="card-header">
        <h4>Overview</h4>
      </div>
      <div class="card-body">
        <table class="table table-striped">
          <tbody>
            <tr>
              <th>Slug</th>
              <td>{{ experiment.slug }}</td>
              <th>Experiment owner</th>
              <td>{{ experiment.owner }}</td>
            </tr>
            <tr>
              <th>Application</th>
              <td>{{ experiment.get_application_display }}</td>
              <th>Public description</th>
              <td>{{ experiment.public_description|format_not_set|safe }}</td>
            </tr>
            <tr>
              <th>Feature config</th>
              <td>
                {% for feature in experiment.feature_configs.all %}
                  {{ feature.name }}- {{ feature.description }}
                {% empty %}
                  <span style="color: red;">Not set</span>
                {% endfor %}
              </td>
              <th>Advanced targeting</th>
              <td>{{ experiment.targeting_config.name }}- {{ experiment.targeting_config.description }}</td>
            </tr>
            <tr>
              <th>Hypothesis</th>
              <td colspan="3">{{ experiment.hypothesis }}</td>
            </tr>
            <tr>
              <th>Primary Outcomes</th>
              <td colspan="3">
                {% for outcome, url in primary_outcome_links %}
                  <a href="{{ url }}" target="_blank" rel="noopener noreferrer">{{ outcome|format_to_title }}</a>
                  {% if not forloop.last %},{% endif %}
                {% empty %}
                  <span style="color: red; ">Not set</span>
                {% endfor %}
              </td>
            </tr>
            <tr>
              <th>Secondary Outcomes</th>
              <td colspan="3">
                {% for outcome, url in secondary_outcome_links %}
                  <a href="{{ url }}" target="_blank" rel="noopener noreferrer">{{ outcome|format_to_title }}</a>
                  {% if not forloop.last %},{% endif %}
                {% empty %}
                  <span style="color: red; ">Not set</span>
                {% endfor %}
              </td>
            </tr>
            <tr>
              <th>Team projects</th>
              <td>
                {{ experiment.projects.all|join:"<br>"|format_not_set|safe }}
              </td>
              <th>Subscribers</th>
              <td>
                {{ experiment.subscribers.all|join:"<br>"|format_not_set|safe }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Risk Mitigation Questions Card -->
    <div class="card mb-3">
      <div class="card-header">
        <h4>Risk Mitigation Questions</h4>
      </div>
      <div class="card-body">
        <table class="table table-striped">
          <tbody>
            <tr>
              <th colspan=3>{{ RISK_QUESTIONS.BRAND }}</th>
              <td style="{% if experiment.risk_brand|yesno == 'Yes' %}color: red;
                         font-weight: bold;
                         {% endif %}">{{ experiment.risk_brand|yesno|format_not_set|safe }}</td>
            </tr>
            <tr>
              <th colspan="3">{{ RISK_QUESTIONS.MESSAGE }} Message Consult</th>
              <td style="{% if experiment.risk_message|yesno == 'Yes' %}color: red;
                         font-weight: bold;
                         {% endif %}">{{ experiment.risk_message|yesno|format_not_set|safe }}</td>
            </tr>
            <tr>
              <th colspan="3">{{ RISK_QUESTIONS.REVENUE }}</th>
              <td style="{% if experiment.risk_revenue|yesno == 'Yes' %}color: red;
                         font-weight: bold;
                         {% endif %}">{{ experiment.risk_revenue|yesno|format_not_set|safe }}</td>
            </tr>
            <tr>
              <th colspan="3">{{ RISK_QUESTIONS.PARTNER }}</th>
              <td style="{% if experiment.risk_partner_related|yesno == 'Yes' %}color: red;
                         font-weight: bold;
                         {% endif %}">{{ experiment.risk_partner_related|yesno|format_not_set|safe }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Audience Card -->
    <div class="card mb-3">
      <div class="card-header">
        <h4>Audience</h4>
      </div>
      <div class="card-body">
        <table class="table table-striped">
          <tbody>
            <tr>
              <th>Channel</th>
              <td style="text-transform: capitalize;">{{ experiment.channel|default:"No Channel" }}</td>
              <th>Advanced Targeting</th>
              <td>{{ experiment.targeting_config.name }}</td>
            </tr>
            <tr>
              <th>Minimum version</th>
              <td>{{ experiment.firefox_min_version|parse_version }}</td>
              <th>Maximum version</th>
              <td>{{ experiment.firefox_max_version|parse_version }}</td>
            </tr>
            <tr>
              <th>Locales</th>
              <td>
                {{ experiment.locales.all|join:"<br>"|default:"All Locales" }}
              </td>
              <th>Countries</th>
              <td>
                {{ experiment.countries.all|join:"<br>"| default:"All Countries" }}
              </td>
            </tr>
            <tr>
              <th>Expected enrolled clients</th>
              <td>{{ experiment.total_enrolled_clients }}</td>
              <th>Population %</th>
              <td>{{ experiment.population_percent|floatformat:"-1" }}%</td>
            </tr>
            <tr>
              <th>Sticky enrollment</th>
              <td colspan="3">{{ experiment.is_sticky }}</td>
            </tr>
            <tr>
              <th>Required experiments</th>
              <td>
                {{ experiment.required_experiments.all|join:"<br>"|default:"None" }}
              </td>
              <th>Excluded experiments</th>
              <td>
                {{ experiment.excluded_experiments.all|join:"<br>"|default:"None" }}
              </td>
            </tr>
            <tr>
              <th>Full targeting expression</th>
              <td colspan="3">{{ experiment.targeting }}</td>
            </tr>
            <tr>
              <th>Recipe JSON</th>
              <td colspan="3">{{ experiment.targeting }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Actions Recommended Before Launch Card -->
    <div class="card mb-3">
      <div class="card-header">
        <h4>Actions that were recommended before launch</h4>
      </div>
      <div class="card-body">
        <table class="table table-striped">
          <tbody>
            <tr>
              <th>QA Sign-off</th>
              <td colspan=3>
                {% if experiment.signoff_recommendations.qa_signoff %}<span style="color: green;">Recommended:</span>{% endif %}
                Please file a QA request. Learn More
              </td>
            </tr>
            <tr>
              <th>VP Sign-off</th>
              <td colspan=3>
                {% if experiment.signoff_recommendations.vp_signoff %}<span style="color: green;">Recommended:</span>{% endif %}
                Please email your VP. Learn More
              </td>
            </tr>
            <tr>
              <th>Legal Sign-off</th>
              <td colspan=3>
                {% if experiment.signoff_recommendations.legal_signoff %}<span style="color: green;">Recommended:</span>{% endif %}
                Please email legal. Learn More
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Branches Card -->
    <div class="card mb-3">
      <div class="card-header">
        <h4>Branches ({{ experiment.branches.all.count }})</h4>
      </div>
      {% for branch in experiment.branches.all %}
        <div class="card-body">
          <div class="row mb-2">
            <div class="col-md-8">
              <h6>
                <a href="#{{ branch.slug }}">#</a> {{ branch.name|title }}
              </h6>
            </div>
            {% if not experiment.is_rollout %}
              <div class="col-md-4 text-right">
                <button class="btn btn-outline-primary btn-sm">Promote to Rollout</button>
              </div>
            {% endif %}
          </div>
          <table class="table table-striped">
            <tbody>
              <tr>
                <th>Slug</th>
                <td>{{ branch.slug|format_not_set|safe }}</td>
                <th>Ratio</th>
                <td>{{ branch.ratio|format_not_set|safe }}</td>
              </tr>
              <tr>
                <th>Description</th>
                <td colspan="3">{{ branch.description|format_not_set|safe }}</td>
              </tr>
              {% if branch.feature_values.all %}
                {% for feature_value in branch.feature_values.all %}
                  <tr>
                    <th>{{ feature_value.feature_config.name|format_not_set|safe }} Value</th>
                    <td colspan="3">{{ feature_value.value|format_not_set|safe }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="4">No Feature Values</td>
                </tr>
              {% endif %}
              {% if branch.screenshots.all.exists %}
                <tr>
                  <th>Screenshots</th>
                  <td colspan="3">
                    {% for screenshot in branch.screenshots.all %}
                      <figure class="d-block">
                        <figcaption>{{ screenshot.description }}</figcaption>
                        {% if screenshot.image %}
                          <img src="{{ screenshot.image.url }}"
                               alt="{{ screenshot.description|default:'' }}"
                               class="img-fluid">
                        {% else %}
                          Not Set
                        {% endif %}
                      </figure>
                    {% endfor %}
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      {% endfor %}
    </div>
    <!-- QA Card -->
    <div class="card">
      <div class="card-header">
        <h4>Quality Assurance</h4>
      </div>
      <div class="card-body">
        <table class="table table-striped">
          <tbody>
            <tr>
              <th>QA Status</th>
              <td colspan="3">{{ experiment.qa_status|lower|capfirst }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}
