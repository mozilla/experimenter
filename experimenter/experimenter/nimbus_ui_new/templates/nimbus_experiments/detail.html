{% extends "nimbus_experiments/experiment_base.html" %}

{% load static %}
{% load nimbus_extras %}

{% block title %}{{ experiment.name }}{% endblock %}

{% block main_content %}
  <div class="container-fluid">
    <!-- Experiment Details Card -->
    <div class="row">
      <div class="col-6">
        <h4 class="mb-0">{{ experiment.name }}</h4>
        <span class="{{ experiment.qa_status_badge_class }}">
          QA Status: {{ experiment.qa_status|default:"Not Set"|title }}
        </span>
        <p class="text-secondary">{{ experiment.slug }}</p>
      </div>
      {% include "nimbus_experiments/timeline.html" %}

    </div>
    <!-- Takeaways Card -->
    {% include "nimbus_experiments/takeaways_card.html" %}

    <!-- Overview Card -->
    <div class="card mb-3">
      <div class="card-header">
        <h4>Overview</h4>
      </div>
      <div class="card-body">
        <table class="table table-striped">
          <tbody>
            <tr>
              <th>Slug</th>
              <td>{{ experiment.slug }}</td>
              <th>Experiment owner</th>
              <td>{{ experiment.owner }}</td>
            </tr>
            <tr>
              <th>Application</th>
              <td>{{ experiment.get_application_display }}</td>
              <th>Public description</th>
              <td>{{ experiment.public_description|format_not_set }}</td>
            </tr>
            <tr>
              <th>Feature config</th>
              <td>
                {% for feature in experiment.feature_configs.all %}
                  {{ feature.name }} - {{ feature.description }}
                {% empty %}
                  <span class="text-danger">Not set</span>
                {% endfor %}
              </td>
              <th>Advanced targeting</th>
              <td>{{ experiment.targeting_config.name }} - {{ experiment.targeting_config.description }}</td>
            </tr>
            <tr>
              <th>Hypothesis</th>
              <td colspan="3">{{ experiment.hypothesis }}</td>
            </tr>
            <tr>
              <th>Primary Outcomes</th>
              <td colspan="3">
                {% for outcome, url in primary_outcome_links %}
                  <a href="{{ url }}" target="_blank" rel="noopener noreferrer">{{ outcome.title|remove_underscores }}</a>
                  {% if not forloop.last %},{% endif %}
                {% empty %}
                  <span class="text-danger">Not set</span>
                {% endfor %}
              </td>
            </tr>
            <tr>
              <th>Secondary Outcomes</th>
              <td colspan="3">
                {% for outcome, url in secondary_outcome_links %}
                  <a href="{{ url }}" target="_blank" rel="noopener noreferrer">{{ outcome.title|remove_underscores }}</a>
                  {% if not forloop.last %},{% endif %}
                {% empty %}
                  <span class="text-danger">Not set</span>
                {% endfor %}
              </td>
            </tr>
            <tr>
              <th>Segments</th>
              <td colspan="3">
                {% for segment, url in segment_links %}
                  <a href="{{ url }}" target="_blank" rel="noopener noreferrer">{{ segment.title|remove_underscores }}</a>
                  {% if not forloop.last %},{% endif %}
                {% empty %}
                  <span class="text-danger">Not set</span>
                {% endfor %}
              </td>
            </tr>
            <tr>
              <th>Team projects</th>
              <td>
                {% for project in experiment.projects.all %}
                  <p>{{ project }}</p>
                {% empty %}
                  <span class="text-danger">Not set</span>
                {% endfor %}
              </td>
              <th>Subscribers</th>
              <td>
                {% for subscriber in experiment.subscribers.all %}
                  <p>{{ subscriber }}</p>
                {% empty %}
                  <span class="text-danger">Not set</span>
                {% endfor %}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Risk Mitigation Questions Card -->
    <div class="card mb-3">
      <div class="card-header">
        <h4>Risk Mitigation Questions</h4>
      </div>
      <div class="card-body">
        <table class="table table-striped">
          <tbody>
            <tr>
              <th colspan="3">{{ RISK_QUESTIONS.BRAND }}</th>
              <td class="{% if experiment.risk_brand %}text-danger font-weight-bold{% endif %}">
                {% if experiment.risk_brand != None %}
                  {{ experiment.risk_brand|yesno:"Yes,No" }}
                {% else %}
                  Not Set
                {% endif %}
              </td>
            </tr>
            <tr>
              <th colspan="3">{{ RISK_QUESTIONS.MESSAGE }}</th>
              <td class="{% if experiment.risk_message %}text-danger font-weight-bold{% endif %}">
                {% if experiment.risk_message != None %}
                  {{ experiment.risk_message|yesno:"Yes,No" }}
                {% else %}
                  Not Set
                {% endif %}
              </td>
            </tr>
            <tr>
              <th colspan="3">{{ RISK_QUESTIONS.REVENUE }}</th>
              <td class="{% if experiment.risk_revenue %}text-danger font-weight-bold{% endif %}">
                {% if experiment.risk_revenue != None %}
                  {{ experiment.risk_revenue|yesno:"Yes,No" }}
                {% else %}
                  Not Set
                {% endif %}
              </td>
            </tr>
            <tr>
              <th colspan="3">{{ RISK_QUESTIONS.PARTNER }}</th>
              <td class="{% if experiment.risk_partner_related %}text-danger font-weight-bold{% endif %}">
                {% if experiment.risk_partner_related != None %}
                  {{ experiment.risk_partner_related|yesno:"Yes,No" }}
                {% else %}
                  Not Set
                {% endif %}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Audience Card -->
    <div class="card mb-3">
      <div class="card-header">
        <h4>Audience</h4>
      </div>
      <div class="card-body">
        <table class="table table-striped">
          <tbody>
            <tr>
              <th>Channel</th>
              <td>{{ experiment.channel.title|default:"No Channel" }}</td>
              <th>Advanced Targeting</th>
              <td>{{ experiment.targeting_config.name }}</td>
            </tr>
            <tr>
              <th>Minimum version</th>
              <td>{{ experiment.firefox_min_version|parse_version }}</td>
              <th>Maximum version</th>
              <td>{{ experiment.firefox_max_version|parse_version }}</td>
            </tr>
            <tr>
              <th>Locales</th>
              <td>
                {{ experiment.locales.all|join:"<br>"|default:"All Locales" }}
              </td>
              <th>Countries</th>
              <td>
                {{ experiment.countries.all|join:"<br>"| default:"All Countries" }}
              </td>
            </tr>
            <tr>
              <th>Expected enrolled clients</th>
              <td>{{ experiment.total_enrolled_clients }}</td>
              <th>Population %</th>
              <td>{{ experiment.population_percent|floatformat:"-1" }}%</td>
            </tr>
            <tr>
              <th>Sticky enrollment</th>
              <td colspan="3">{{ experiment.is_sticky }}</td>
            </tr>
            <tr>
              <th>Required experiments</th>
              <td>
                {{ experiment.required_experiments.all|join:"<br>"|default:"None" }}
              </td>
              <th>Excluded experiments</th>
              <td>
                {{ experiment.excluded_experiments.all|join:"<br>"|default:"None" }}
              </td>
            </tr>
            <tr>
              <th>Full targeting expression</th>
              <td colspan="3">{{ experiment.targeting }}</td>
            </tr>
            <tr>
              <th>Recipe JSON</th>
              <td colspan="3">
                <div class="collapse" id="collapseRecipe">
                  <code>
                    <pre class="text-monospace" style="white-space: pre-wrap; word-wrap: break-word;">
                      {{ experiment.recipe_json|linebreaks|linebreaksbr }}
                    </pre>
                  </code>
                </div>
                <button class="btn btn-outline-primary btn-sm"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseRecipe"
                        aria-expanded="false"
                        aria-controls="collapseRecipe">
                  <i class="fa-solid fa-plus"></i> Show/Hide Recipe
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Actions Recommended Before Launch Card -->
    {% include "nimbus_experiments/signoff_card.html" with edit=False experiment=experiment %}

    <!-- Branches Card -->
    <div class="card mb-3">
      <div class="card-header">
        <h4>Branches ({{ experiment.branches.all.count }})</h4>
      </div>
      {% for branch in experiment.branches.all %}
        <div class="card-body">
          <div class="row mb-2">
            <div class="col-md-8">
              <h6>
                <a href="#{{ branch.slug }}">#</a> {{ branch.name|title }}
              </h6>
            </div>
            {% if not experiment.is_rollout %}
              <div class="col-md-4 text-right">
                <button class="btn btn-outline-primary btn-sm">Promote to Rollout</button>
              </div>
            {% endif %}
          </div>
          <table class="table table-striped">
            <tbody>
              <tr>
                <th>Slug</th>
                <td>{{ branch.slug|format_not_set }}</td>
                <th>Ratio</th>
                <td>{{ branch.ratio|format_not_set }}</td>
              </tr>
              <tr>
                <th>Description</th>
                <td colspan="3">{{ branch.description|format_not_set }}</td>
              </tr>
              {% if branch.feature_values.all %}
                {% for feature_value in branch.feature_values.all %}
                  <tr>
                    <th>{{ feature_value.feature_config.name|format_not_set }} Value</th>
                    <td colspan="3">{{ feature_value.value|format_not_set }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="4">No Feature Values</td>
                </tr>
              {% endif %}
              {% if branch.screenshots.all.exists %}
                <tr>
                  <th>Screenshots</th>
                  <td colspan="3">
                    {% for screenshot in branch.screenshots.all %}
                      <figure class="d-block">
                        <figcaption>{{ screenshot.description }}</figcaption>
                        {% if screenshot.image %}
                          <img src="{{ screenshot.image.url }}"
                               alt="{{ screenshot.description|default:'' }}"
                               class="img-fluid">
                        {% else %}
                          Not Set
                        {% endif %}
                      </figure>
                    {% endfor %}
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      {% endfor %}
    </div>
    <!-- QA Card -->
    {% include "nimbus_experiments/qa_card.html" %}

  </div>
{% endblock %}

{% block extrascripts %}
  {{ block.super }}
  <script src="{% static 'nimbus_ui_new/setup_selectpicker.bundle.js' %}"></script>
{% endblock %}
