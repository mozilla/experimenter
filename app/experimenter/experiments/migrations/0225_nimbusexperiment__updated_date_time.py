# Generated by Django 3.2.14 on 2022-07-12 21:19


from django.db import migrations, models


def update_updated_date_time_with_changelog_last_changed_on(apps, schema_editor):
    NimbusExperiment = apps.get_model("experiments", "NimbusExperiment")
    for experiment in NimbusExperiment.objects.all():

        # disabling auto_now
        experiment._meta.get_field("_updated_date_time").auto_now = False

        if change := experiment.changes.all().order_by("-changed_on").first():
            experiment._updated_date_time = change.changed_on
            experiment.save()
        # Re-enabling auto_now
        experiment._meta.get_field("_updated_date_time").auto_now = True


class Migration(migrations.Migration):

    dependencies = [
        ("experiments", "0224_analysis_add_basis"),
    ]

    operations = [
        migrations.AddField(
            model_name="nimbusexperiment",
            name="_updated_date_time",
            field=models.DateTimeField(auto_now=True),
        ),
        migrations.RunPython(update_updated_date_time_with_changelog_last_changed_on),
    ]
